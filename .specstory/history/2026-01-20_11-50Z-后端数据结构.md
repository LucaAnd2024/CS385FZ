<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 52659562-99a0-4262-821b-03e30801b491 (2026-01-20 11:50Z) -->

# 后端数据结构 (2026-01-20 11:50Z)

_**User**_

帮我查一下我后端现在的数据结构是什么样子的 @MynoteBack 

---

_**Agent (model gpt-5.2-codex, mode Agent)**_

<think><details><summary>Thought Process</summary>
**Planning backend exploration**

I'm preparing to explore the backend codebase using search and file read tools, focusing on models and relevant logic, with queries in Chinese.</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="list_dir_v2">
<details>
<summary>Tool use: **list_dir_v2**</summary>


Parameters:

```json
{
  "targetDirectory": "/Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack"
}
```
Result:

```json
{
  "directoryTreeRoot": {
    "absPath": "/Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack",
    "childrenDirs": [
      {
        "absPath": "/Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/models",
        "childrenFiles": [
          {
            "name": "__init__.py"
          },
          {
            "name": "emotion.py"
          },
          {
            "name": "music_task.py"
          },
          {
            "name": "score.py"
          },
          {
            "name": "user.py"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "/Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/routers",
        "childrenFiles": [
          {
            "name": "__init__.py"
          },
          {
            "name": "ai.py"
          },
          {
            "name": "emotions.py"
          },
          {
            "name": "music.py"
          },
          {
            "name": "scores.py"
          },
          {
            "name": "users.py"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "/Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/schemas",
        "childrenFiles": [
          {
            "name": "__init__.py"
          },
          {
            "name": "ai.py"
          },
          {
            "name": "emotion.py"
          },
          {
            "name": "music.py"
          },
          {
            "name": "score.py"
          },
          {
            "name": "user.py"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "/Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/services",
        "childrenFiles": [
          {
            "name": "__init__.py"
          },
          {
            "name": "ai_service.py"
          },
          {
            "name": "emotion_service.py"
          },
          {
            "name": "music_mapper.py"
          },
          {
            "name": "response.py"
          },
          {
            "name": "score_service.py"
          },
          {
            "name": "security.py"
          },
          {
            "name": "suno_client.py"
          },
          {
            "name": "user_service.py"
          }
        ],
        "childrenWereProcessed": true
      }
    ],
    "childrenFiles": [
      {
        "name": "check_server.sh"
      },
      {
        "name": "CONFIG.md"
      },
      {
        "name": "config.py"
      },
      {
        "name": "debug_suno_query.py"
      },
      {
        "name": "deploy.sh"
      },
      {
        "name": "DEPLOYMENT_GUIDE.md"
      },
      {
        "name": "main.py"
      },
      {
        "name": "Procfile"
      },
      {
        "name": "QUICK_DEPLOY.md"
      },
      {
        "name": "README_DEPLOY.md"
      },
      {
        "name": "README.md"
      },
      {
        "name": "requirements.txt"
      },
      {
        "name": "start_server.sh"
      },
      {
        "name": "SUNO_API_DEBUG_REPORT.md"
      },
      {
        "name": "test_suno_api.py"
      }
    ],
    "childrenWereProcessed": true
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Identifying data structure models**

I'm focusing on locating read models and schemas that define data structures, planning to use multiple read file operations to gather them.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/models/user.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/models/emotion.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/models/music_task.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/models/score.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/models/__init__.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/config.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Reviewing existing API schemas**

I'm inspecting the files under the schemas directory to understand existing API shape definitions and determine how to structure new schemas.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/schemas/user.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/schemas/emotion.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/schemas/music.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/schemas/score.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/schemas/ai.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/lijialiang/Projects/RNproject/CS385FZ/MynoteBack/schemas/__init__.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**总结数据库和数据结构**

数据库包含四个表：users（用户信息，包括id、name、email等字段）、emotion_days（情绪记录，包含用户id、日期、情绪标签、备注等）、music_tasks（音乐任务，字段有任务id、用户id、任务描述、状态等）、scores（分数记录，关联任务和用户，含分数值和时间）。数据库连接通过配置的URL管理。部分字段以JSON格式存储，方便灵活扩展。API层使用Pydantic定义请求和响应的JSON数据结构，确保数据校验和序列化。</details></think>

---

后端当前的数据结构主要由 SQLAlchemy 数据库模型 + Pydantic 接口结构组成，核心在 `MynoteBack/models/` 和 `MynoteBack/schemas/`。概览如下（字段按代码定义）：

## 数据库表结构（SQLAlchemy）
- **`users`**（`models/user.py`）
  - `id` int 主键
  - `email` string(255) 可空，唯一
  - `phone` string(32) 可空，唯一
  - `username` string(50) 可空
  - `password_hash` string(255) 必填
  - `created_at` / `updated_at` 时间戳
- **`emotion_days`**（`models/emotion.py`）
  - `id` int 主键
  - `date` string(32) 唯一，格式 `yyyy-MM-dd`
  - `data` JSON（整天情绪数据）
  - `created_at` / `updated_at`
- **`music_tasks`**（`models/music_task.py`）
  - `id` int 主键
  - `task_id` string(128) 唯一，Suno 任务 ID
  - `date` string(32) `YYYY-MM-DD`
  - `task_type` string(32) 默认 `daily`
  - `status` string(32) 默认 `queued`
  - `music_url` string(512) 可空
  - `duration` int 可空（秒）
  - `suno_params` JSON 可空
  - `created_at` / `finished_at` / `updated_at`
- **`scores`**（`models/score.py`）
  - `id` int 主键
  - `uuid` string(36) 唯一（对齐前端 Score.id）
  - `title` string(255) 可空
  - `data` JSON（完整 Score 数据）
  - `created_at` / `updated_at`

## 接口数据结构（Pydantic）
- **用户**（`schemas/user.py`）
  - 注册 `UserRegister`: `email/phone/username` + `password`
  - 登录 `UserLogin`: `login` + `password`
  - 输出 `UserOut`: `id/email/phone/username/created_at`
- **情绪日记**（`schemas/emotion.py`）
  - `EmotionDayData`: `date` + `events[]` + `finalPrompt?` + `musicGenerated`
  - `EmotionEvent`: `time/hr/hrv/triggered/userInput/emotion/phrase[]` + AI 可选字段
  - `EmotionNote`: `pitch/duration/velocity`
  - `MusicStatusUpdate`: `prompt?` + `generated`
- **音乐生成**（`schemas/music.py`）
  - 日/周生成请求 `DailyMusicRequest` / `WeeklyMusicRequest`
  - 查询响应 `MusicQueryResponse`
  - 回调 `SunoCallback`
  - 数据库输出 `MusicTaskOut`
- **乐谱/情绪五线谱**（`schemas/score.py`）
  - `Score`: `id/title/staves[]/createdAt`
  - `StaffScore` / `StaffEmotionNote` 含位置、颜色、大小等绘制字段
- **AI 对话**（`schemas/ai.py`）
  - `ChatRoundInput` / `ChatTextInput` / `ChatOutput`

如需我按“接口路由 + 实际存储 JSON 结构”进一步对齐（例如 `emotion_days.data` 或 `scores.data` 的具体 JSON 字段），告诉我目标接口或表名即可。

---

